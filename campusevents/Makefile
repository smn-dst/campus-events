# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CampusEvents â€” Makefile
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Couleurs pour le help
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RESET  := \033[0m

.DEFAULT_GOAL := help

# â”€â”€ Installation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: setup
setup: ## ğŸ“ Installation complÃ¨te (1Ã¨re fois aprÃ¨s clone)
	@test -f .env || (cp .env.example .env && echo "âœ… .env crÃ©Ã© depuis .env.example")
	docker compose up -d --build
	@echo "â³ Attente que la DB soit prÃªte..."
	@sleep 5
	docker compose run --rm --build seed
	@echo ""
	@echo "ğŸ‰ CampusEvents est prÃªt !"
	@echo "   Frontend : http://app.localhost"
	@echo "   API :      http://api.localhost"
	@echo "   Swagger :  http://api.localhost/api/docs"
	@echo ""
	@echo "   Admin : admin@campus.fr / admin123"
	@echo "   User  : alice@campus.fr / user123"

# â”€â”€ Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: up
up: ## Lancer l'application (production)
	docker compose up -d --build

.PHONY: down
down: ## ArrÃªter tous les services
	docker compose down

.PHONY: restart
restart: down up ## RedÃ©marrer tous les services

# â”€â”€ DÃ©veloppement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: dev
dev: ## Lancer en mode dÃ©veloppement (hot-reload)
	docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build

.PHONY: dev-down
dev-down: ## ArrÃªter le mode dÃ©veloppement
	docker compose -f docker-compose.yml -f docker-compose.dev.yml down

# â”€â”€ Base de donnÃ©es â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: migrate
migrate: ## ExÃ©cuter les migrations Prisma
	docker compose run --rm --build migrate

.PHONY: seed
seed: ## Charger les donnÃ©es de test
	docker compose run --rm --build seed

.PHONY: db-shell
db-shell: ## Ouvrir un shell PostgreSQL (ex. \dt pour les tables, SELECT * FROM "User";)
	docker compose exec db psql -U campus -d campusevents

.PHONY: db-reset
db-reset: ## Reset complet de la DB (volumes supprimÃ©s)
	docker compose down -v
	$(MAKE) up
	sleep 5
	$(MAKE) migrate
	$(MAKE) seed

# â”€â”€ Logs & Debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: logs
logs: ## Voir les logs de tous les services
	docker compose logs -f

.PHONY: logs-back
logs-back: ## Logs du backend uniquement
	docker compose logs -f backend

.PHONY: logs-front
logs-front: ## Logs du frontend uniquement
	docker compose logs -f frontend

.PHONY: logs-worker
logs-worker: ## Logs du worker uniquement
	docker compose logs -f worker

.PHONY: ps
ps: ## Ã‰tat des services
	docker compose ps

.PHONY: health
health: ## VÃ©rifier les healthchecks
	@echo "$(YELLOW)â”€â”€ Healthchecks â”€â”€$(RESET)"
	@docker inspect campus-db --format='DB:       {{.State.Health.Status}}' 2>/dev/null || echo "DB:       not running"
	@docker inspect campus-redis --format='Redis:    {{.State.Health.Status}}' 2>/dev/null || echo "Redis:    not running"
	@docker inspect campus-backend --format='Backend:  {{.State.Health.Status}}' 2>/dev/null || echo "Backend:  not running"

# â”€â”€ Nettoyage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: clean
clean: ## Supprimer les conteneurs, rÃ©seaux et volumes
	docker compose down -v --remove-orphans
	docker system prune -f

# â”€â”€ ScÃ©nario de panne â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: test
test: ## ğŸ§ª Lancer les tests unitaires
	docker compose run --rm --build -e JWT_SECRET=dev-secret backend npm test

# â”€â”€ Panne Redis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: chaos-redis
chaos-redis: ## Simuler une panne Redis
	@echo "$(YELLOW)ArrÃªt de Redis...$(RESET)"
	docker compose stop redis
	@echo "$(YELLOW)Redis arrÃªtÃ©. Observez les logs :$(RESET)"
	@echo "  make logs-back"
	@echo "  make logs-worker"
	@echo "$(YELLOW)Pour relancer : docker compose start redis$(RESET)"

# â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.PHONY: help
help: ## Afficher cette aide
	@echo "$(GREEN)â•â•â• CampusEvents â•â•â•$(RESET)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2}'
	@echo ""